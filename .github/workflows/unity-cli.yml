name: Unity CLI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  UNITY_VERSION: 6000.2.10f1
  UNITY_VERSION_CHANGESET: d3d30d158480

jobs:
  test:
    name: Run Unity Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Cache Unity Installation
        id: cache-unity
        uses: actions/cache@v4
        with:
          path: ~/Unity
          key: unity-${{ env.UNITY_VERSION }}-${{ runner.os }}
      
      - name: Cache Library Folder
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ runner.os }}-${{ env.UNITY_VERSION }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ runner.os }}-${{ env.UNITY_VERSION }}-
            Library-${{ runner.os }}-
      
      - name: Install Unity Hub
        if: steps.cache-unity.outputs.cache-hit != 'true'
        run: |
          echo "Installing Unity Hub..."
          wget -q https://public-cdn.cloud.unity3d.com/hub/prod/UnityHubSetup.AppImage
          chmod +x UnityHubSetup.AppImage
          ./UnityHubSetup.AppImage --appimage-extract
          sudo mv squashfs-root /opt/unityhub
          sudo ln -s /opt/unityhub/AppRun /usr/bin/unity-hub
      
      - name: Install Unity Editor
        if: steps.cache-unity.outputs.cache-hit != 'true'
        run: |
          echo "Installing Unity ${{ env.UNITY_VERSION }}..."
          
          # Install Unity Editor via Hub
          unity-hub install --version ${{ env.UNITY_VERSION }} --changeset ${{ env.UNITY_VERSION_CHANGESET }} || true
          
          # Alternative: Direct download if Hub fails
          UNITY_DOWNLOAD_URL="https://download.unity3d.com/download_unity/${{ env.UNITY_VERSION_CHANGESET }}/LinuxEditorInstaller/Unity.tar.xz"
          
          echo "Downloading Unity from: $UNITY_DOWNLOAD_URL"
          wget -q -O Unity.tar.xz "$UNITY_DOWNLOAD_URL"
          
          echo "Extracting Unity..."
          mkdir -p ~/Unity/Editor
          tar -xf Unity.tar.xz -C ~/Unity/Editor
          
          echo "Unity installed to: ~/Unity/Editor"
          ls -la ~/Unity/Editor
      
      - name: Activate Unity License
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        run: |
          echo "Activating Unity license..."
          
          UNITY_PATH="${HOME}/Unity/Editor/Unity"
          
          if [ ! -f "$UNITY_PATH" ]; then
            echo "Unity executable not found at $UNITY_PATH"
            find ~/Unity -name "Unity" -type f
            exit 1
          fi
          
          # Activate license (Personal or Plus/Pro)
          if [ -n "$UNITY_SERIAL" ]; then
            # Pro/Plus license with serial
            $UNITY_PATH -quit -batchmode -nographics \
              -serial "$UNITY_SERIAL" \
              -username "$UNITY_EMAIL" \
              -password "$UNITY_PASSWORD"
          else
            # Personal license
            $UNITY_PATH -quit -batchmode -nographics \
              -username "$UNITY_EMAIL" \
              -password "$UNITY_PASSWORD" \
              -logFile /dev/stdout
          fi
          
          echo "License activation complete"
      
      - name: Run EditMode Tests
        run: |
          echo "Running EditMode tests..."
          
          UNITY_PATH="${HOME}/Unity/Editor/Unity"
          
          $UNITY_PATH \
            -batchmode \
            -nographics \
            -projectPath . \
            -runTests \
            -testPlatform EditMode \
            -testResults test-results-editmode.xml \
            -logFile - \
            || true
          
          echo "EditMode tests complete"
      
      - name: Run PlayMode Tests
        run: |
          echo "Running PlayMode tests..."
          
          UNITY_PATH="${HOME}/Unity/Editor/Unity"
          
          $UNITY_PATH \
            -batchmode \
            -nographics \
            -projectPath . \
            -runTests \
            -testPlatform PlayMode \
            -testResults test-results-playmode.xml \
            -logFile - \
            || true
          
          echo "PlayMode tests complete"
      
      - name: Parse Test Results
        if: always()
        run: |
          echo "=== Test Results Summary ==="
          
          if [ -f "test-results-editmode.xml" ]; then
            echo "EditMode Results:"
            grep -o 'total="[^"]*"' test-results-editmode.xml || echo "No results found"
            grep -o 'passed="[^"]*"' test-results-editmode.xml || echo "No passed count"
            grep -o 'failed="[^"]*"' test-results-editmode.xml || echo "No failed count"
          else
            echo "⚠️ EditMode results not found"
          fi
          
          if [ -f "test-results-playmode.xml" ]; then
            echo "PlayMode Results:"
            grep -o 'total="[^"]*"' test-results-playmode.xml || echo "No results found"
            grep -o 'passed="[^"]*"' test-results-playmode.xml || echo "No passed count"
            grep -o 'failed="[^"]*"' test-results-playmode.xml || echo "No failed count"
          else
            echo "⚠️ PlayMode results not found"
          fi
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Test Results
          path: |
            test-results-*.xml
            *.log
      
      - name: Return Unity License
        if: always()
        run: |
          echo "Returning Unity license..."
          
          UNITY_PATH="${HOME}/Unity/Editor/Unity"
          
          if [ -f "$UNITY_PATH" ]; then
            $UNITY_PATH -quit -batchmode -returnlicense || true
          fi
          
          echo "License returned"

  build:
    name: Build Windows
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Cache Unity Installation
        id: cache-unity
        uses: actions/cache@v4
        with:
          path: ~/Unity
          key: unity-${{ env.UNITY_VERSION }}-${{ runner.os }}
      
      - name: Cache Library Folder
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ runner.os }}-${{ env.UNITY_VERSION }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ runner.os }}-${{ env.UNITY_VERSION }}-
            Library-${{ runner.os }}-
      
      - name: Install Unity (if not cached)
        if: steps.cache-unity.outputs.cache-hit != 'true'
        run: |
          echo "Installing Unity ${{ env.UNITY_VERSION }}..."
          
          UNITY_DOWNLOAD_URL="https://download.unity3d.com/download_unity/${{ env.UNITY_VERSION_CHANGESET }}/LinuxEditorInstaller/Unity.tar.xz"
          
          wget -q -O Unity.tar.xz "$UNITY_DOWNLOAD_URL"
          mkdir -p ~/Unity/Editor
          tar -xf Unity.tar.xz -C ~/Unity/Editor
      
      - name: Activate Unity License
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        run: |
          UNITY_PATH="${HOME}/Unity/Editor/Unity"
          
          if [ -n "$UNITY_SERIAL" ]; then
            $UNITY_PATH -quit -batchmode -nographics \
              -serial "$UNITY_SERIAL" \
              -username "$UNITY_EMAIL" \
              -password "$UNITY_PASSWORD"
          else
            $UNITY_PATH -quit -batchmode -nographics \
              -username "$UNITY_EMAIL" \
              -password "$UNITY_PASSWORD" \
              -logFile /dev/stdout
          fi
      
      - name: Build Windows
        run: |
          echo "Building for Windows..."
          
          UNITY_PATH="${HOME}/Unity/Editor/Unity"
          
          $UNITY_PATH \
            -quit \
            -batchmode \
            -nographics \
            -projectPath . \
            -buildWindows64Player "Builds/SantasWorkshop.exe" \
            -logFile - \
            || true
          
          echo "Build complete"
      
      - name: Upload Build
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Build-Windows
          path: Builds/
      
      - name: Return Unity License
        if: always()
        run: |
          UNITY_PATH="${HOME}/Unity/Editor/Unity"
          if [ -f "$UNITY_PATH" ]; then
            $UNITY_PATH -quit -batchmode -returnlicense || true
          fi
